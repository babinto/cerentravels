<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        margin: 0;
        font-family: 'Helvetica Neue', sans-serif;
        background-color: #fff;
        color: #000;
      }
      #map {
        height: 100vh;
        width: 100vw;
      }
      #searchBox {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      #searchInput {
        width: 250px;
        padding: 6px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="searchBox">
      <input type="text" id="searchInput" placeholder="Ceren travels to..." />
      <button onclick="searchCity()">Add</button>
    </div>
    <div id="map"></div>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCD_PLUZ_SAdlzOsqWWjzhi8voYUGd7ftE",
        authDomain: "ceren-travels.firebaseapp.com",
        projectId: "ceren-travels",
        storageBucket: "ceren-travels.appspot.com",
        messagingSenderId: "579239744378",
        appId: "1:579239744378:web:2b034208cf0842cb6cfcc3"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const map = L.map('map').setView([20, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      async function loadMarkers() {
        const snapshot = await db.collection('markers').get();
        snapshot.forEach(doc => {
          const data = doc.data();
          createMarker(data.lat, data.lng, data.name, data.notes, data.date, doc.id);
        });
      }

      function createMarker(lat, lng, name, notes = '', date = '', id = null) {
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`
          <strong>${name}</strong><br>
          ${notes ? 'Notes: ' + notes + '<br>' : ''}
          ${date ? 'Date: ' + date + '<br>' : ''}
          <button onclick="editMarker('${id}')">Edit</button>
          <button onclick="deleteMarker('${id}')">Delete</button>
        `);
      }

      async function searchCity() {
        const city = document.getElementById("searchInput").value;
        if (!city) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
        const data = await res.json();
        if (data.length > 0) {
          const { lat, lon, display_name } = data[0];
          const notes = prompt("Enter notes:");
          const date = prompt("Enter visit date:");

          const docRef = await db.collection('markers').add({
            lat: parseFloat(lat),
            lng: parseFloat(lon),
            name: display_name,
            notes,
            date
          });

          createMarker(lat, lon, display_name, notes, date, docRef.id);
          map.setView([lat, lon], 5);
          document.getElementById("searchInput").value = "";
        } else {
          alert("City not found.");
        }
      }

      async function editMarker(id) {
        const doc = await db.collection('markers').doc(id).get();
        const data = doc.data();

        const newName = prompt("Edit city name:", data.name);
        const newNotes = prompt("Edit notes:", data.notes);
        const newDate = prompt("Edit date:", data.date);

        await db.collection('markers').doc(id).set({
          lat: data.lat,
          lng: data.lng,
          name: newName,
          notes: newNotes,
          date: newDate
        });

        location.reload();
      }

      async function deleteMarker(id) {
        await db.collection('markers').doc(id).delete();
        location.reload();
      }

      loadMarkers();
    </script>
  </body>
</html>