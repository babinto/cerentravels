<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #fff;
      color: #000;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    #searchBox {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #searchInput {
      width: 250px;
      padding: 6px;
      font-size: 16px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
      margin-top: 5px;
      resize: vertical;
    }
    input[type="date"] {
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .popup-content {
      min-width: 200px;
    }
  </style>
</head>
<body>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="ceren travels to..." />
    <button onclick="searchCity()">Add</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = JSON.parse(localStorage.getItem('cityMarkers')) || [];

    function createMarker(lat, lng, name, notes = '', date = '') {
      const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      
      const popupContent = document.createElement('div');
      popupContent.className = 'popup-content';
      popupContent.innerHTML = `
        <strong>${name}</strong><br/>
        <label>Notes:</label><br/>
        <textarea id="notes" rows="3">${notes}</textarea><br/>
        <label>Date visited:</label><br/>
        <input type="date" id="date" value="${date}" /><br/><br/>
        <button id="saveBtn">Save</button>
        <button id="editBtn" style="display:none;">Edit</button>
        <button id="deleteBtn">Delete</button>
      `;

      marker.bindPopup(popupContent);

      marker.on('popupopen', () => {
        const saveBtn = popupContent.querySelector('#saveBtn');
        const editBtn = popupContent.querySelector('#editBtn');
        const deleteBtn = popupContent.querySelector('#deleteBtn');
        const notesInput = popupContent.querySelector('#notes');
        const dateInput = popupContent.querySelector('#date');

        saveBtn.onclick = () => {
          const newNotes = notesInput.value;
          const newDate = dateInput.value;
          updateMarker(lat, lng, name, newNotes, newDate);
          marker.closePopup();
        };

        deleteBtn.onclick = () => {
          deleteMarker(lat, lng);
          marker.closePopup();
        };

        // Disable textarea and date input after save to simulate edit mode
        editBtn.onclick = () => {
          notesInput.disabled = false;
          dateInput.disabled = false;
          saveBtn.style.display = 'inline';
          editBtn.style.display = 'none';
        };

        // Initially inputs enabled, hide edit button
        notesInput.disabled = false;
        dateInput.disabled = false;
        saveBtn.style.display = 'inline';
        editBtn.style.display = 'none';
      });

      marker.on('dragend', (e) => {
        const newLatLng = e.target.getLatLng();
        updateMarkerPosition(lat, lng, newLatLng.lat, newLatLng.lng);
        lat = newLatLng.lat;
        lng = newLatLng.lng;
      });
    }

    function updateMarker(oldLat, oldLng, name, notes, date) {
      const idx = markers.findIndex(m => m.lat === oldLat && m.lng === oldLng);
      if (idx !== -1) {
        markers[idx].name = name;
        markers[idx].notes = notes;
        markers[idx].date = date;
        localStorage.setItem('cityMarkers', JSON.stringify(markers));
        location.reload();
      }
    }

    function updateMarkerPosition(oldLat, oldLng, newLat, newLng) {
      const idx = markers.findIndex(m => m.lat === oldLat && m.lng === oldLng);
      if (idx !== -1) {
        markers[idx].lat = newLat;
        markers[idx].lng = newLng;
        localStorage.setItem('cityMarkers', JSON.stringify(markers));
        location.reload();
      }
    }

    function deleteMarker(lat, lng) {
      markers = markers.filter(m => m.lat !== lat || m.lng !== lng);
      localStorage.setItem('cityMarkers', JSON.stringify(markers));
      location.reload();
    }

    function saveMarker(marker) {
      markers.push(marker);
      localStorage.setItem('cityMarkers', JSON.stringify(markers));
    }

    markers.forEach(({ lat, lng, name, notes = '', date = '' }) => {
      createMarker(lat, lng, name, notes, date);
    });

    map.on('click', e => {
      const name = prompt("Enter city name:");
      if (name) {
        const { lat, lng } = e.latlng;
        createMarker(lat, lng, name);
        saveMarker({ lat, lng, name, notes: '', date: '' });
      }
    });

    async function searchCity() {
      const city = document.getElementById("searchInput").value.trim();
      if (!city) return;
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await res.json();
      if (data.length > 0) {
        const { lat, lon, display_name } = data[0];
        createMarker(lat, lon, display_name);
        saveMarker({ lat: parseFloat(lat), lng: parseFloat(lon), name: display_name, notes: '', date: '' });
        map.setView([lat, lon], 5);
        document.getElementById("searchInput").value = "";
      } else {
        alert("City not found.");
      }
    }
  </script>
</body>
</html>
